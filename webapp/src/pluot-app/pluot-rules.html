<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pluot-app/pluot-globals.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<script src="common.js"></script>

<dom-module id="pluot-rules">
  <template>
    <style include="iron-flex iron-flex-alignment">
      paper-card {
        padding: 16px;
        cursor: pointer;
      }
      label {
        font-family: sans-serif;
        font-size: 16pt;
        padding: 16px;
      }
      iron-list > div {
        padding: 16px;
        margin-right: 16px;
      }
      iron-list paper-card {
        width: 200px;
        height: 100px;
      }
      iron-list paper-card.is-selected-true {
        background-color: #583759;
        color: #fff;
      }
    </style>

    <pluot-globals id="globals"></pluot-globals>

    <paper-dialog id="editDialog" class="layout vertical">
      <paper-input label="Pattern" value="{{newRulePattern}}"></paper-input>
      <paper-checkbox checked="{{newRuleRegexp}}">Regexp</paper-checkbox>
      <paper-dropdown-menu label="Category">
        <paper-listbox slot="dropdown-content" attr-for-selected="code" selected="{{newRuleCategoryStr}}">
          <template is="dom-repeat" items="[[$.globals.categories]]" as="category">
            <paper-item code$="[[category.code]]">[[category.displayName]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <div class="layout horizontal end-justified">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="_onCreateRule">Accept</paper-button>
      </div>
    </paper-dialog>

    <div class="layout vertical" fullbleed>
      <label>Proposed Rules</label>
      <iron-list items="[[listRuleProposalsResp.rules]]" as="rule" grid>
        <template>
          <div>
            <paper-card class="layout vertical"
                on-tap="_onProposalTap"
                data-pattern$="[[rule.pattern]]"
                data-category$="[[rule.category]]">
              <span>[[rule.pattern]]</span>
              <span>[[_formatCategory(rule.category)]]</span>
            </paper-card>
          </div>
        </template>
      </iron-list>

      <label>Rules</label>
      <iron-list items="[[listRulesResp.rules]]" as="rule" grid selection-enabled="true" selected-item="{{selectedRule}}">
        <template>
          <div>
            <paper-card class$="layout vertical is-selected-[[selected]]">
              <span>[[rule.pattern]]</span>
              <span>[[_formatCategory(rule.category)]]</span>
            </paper-card>
          </div>
        </template>
      </iron-list>
    </div>

    <iron-ajax
        auto
        url="[[$.globals.urlPrefix]]rules"
        handle-as="json"
        last-response="{{listRulesResp}}"></iron-ajax>
    <iron-ajax
        auto
        url="[[$.globals.urlPrefix]]rules:proposal"
        handle-as="json"
        last-response="{{listRuleProposalsResp}}"></iron-ajax>
    <iron-ajax
        id="createRuleAjax"
        url="[[$.globals.urlPrefix]]rules"
        method="POST"
        content-type="application/json"
        body="[[createRuleReq]]"
        handle-as="json"
        on-response="_addRule"></iron-ajax>
    <iron-ajax
        id="deleteRuleAjax"
        url="[[$.globals.urlPrefix]]rules/[[selectedRule.id]]"
        method="DELETE"
        on-response="_removeRule"></iron-ajax>
  </template>

  <script>
    class PluotRules extends Polymer.Element {
      static get is() { return 'pluot-rules'; }
      static get properties() {
        return {
          createRuleReq: {
            type: Object,
            computed: '_computeCreateRuleReq(newRulePattern, newRuleRegexp, newRuleCategoryStr)',
          },
          toolbar: {
            type: Array,
            notify: true,
            computed: '_computeToolbar(selectedRule)'
          },
          newRulePattern: { type: String, value: "" },
          newRuleCategoryStr: { type: String, value: "" },
          newRuleRegexp: { type: Boolean, value: false },
        };
      }
      create() {
        this.newRulePattern = "";
        this.newRuleCategoryStr = "";
        this.newRuleRegexp = false;
        this.$.editDialog.open();
      }
      delete() {
        this.$.deleteRuleAjax.generateRequest();
      }
      _addRule(evt) {
        this.push('listRulesResp.rules', evt.target.lastResponse);
      }
      _removeRule(evt) {
        var parts = evt.target.lastRequest.url.split('/');
        var deletedId = parts[parts.length-1];
        // Find index of deleted rule.
        var deleted = -1;
        for (var i = 0; i < this.listRulesResp.rules.length; i++) {
          if (this.listRulesResp.rules[i].id == deletedId) {
            deleted = i;
            break;
          }
        }
        if (deleted != -1) {
          this.splice('listRulesResp.rules', deleted, 1);
        }
      }
      _computeCreateRuleReq(newRulePattern, newRuleRegexp, newRuleCategoryStr) {
        return {
          pattern: newRulePattern,
          regexp: newRuleRegexp,
          category: parseInt(newRuleCategoryStr)
        };
      }
      _computeToolbar(selectedRule) {
        return [
          { icon: 'add', handler: 'create' },
          { icon: 'delete', handler: 'delete', disabled: (selectedRule == null) }
        ];
      }
      _onCreateRule() {
        this.$.createRuleAjax.generateRequest();
      }
      _formatCategory(category) { return this.$.globals.categoryName(category); }
      _onProposalTap(evt) {
        this.newRulePattern = evt.currentTarget.dataset.pattern;
        this.newRuleCategoryStr = evt.currentTarget.dataset.category;
        this.$.editDialog.open();
      }
    }

    window.customElements.define(PluotRules.is, PluotRules);
  </script>
</dom-module>

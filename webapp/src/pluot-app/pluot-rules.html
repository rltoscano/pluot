<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pluot-app/pluot-globals.html">
<link rel="import" href="../pluot-app/pluot-rule.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<script src="common.js"></script>

<dom-module id="pluot-rules">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }
      label {
        font-family: sans-serif;
        font-size: 14pt;
        padding: 16px;
      }
      iron-list {
        --iron-list-items-container: {
          padding: 16px;
        };
      }
      iron-list div {
        padding: 16px 0 0 16px;
        cursor: pointer;
      }
    </style>

    <pluot-globals id="globals"></pluot-globals>

    <paper-dialog id="editDialog" class="layout vertical" opened="{{adding}}">
      <paper-input label="Pattern" value="{{newRulePattern}}"></paper-input>
      <paper-checkbox checked="{{newRuleRegexp}}">Regexp</paper-checkbox>
      <paper-input label="Name" value="{{newRuleDisplayName}}"></paper-input>
      <paper-dropdown-menu label="Category">
        <paper-listbox slot="dropdown-content" attr-for-selected="code" selected="{{newRuleCategoryStr}}">
          <template is="dom-repeat" items="[[$.globals.categories]]" as="category">
            <paper-item code$="[[category.code]]">[[category.displayName]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <div class="layout horizontal end-justified">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="_onCreateRule">Accept</paper-button>
      </div>
    </paper-dialog>

    <label>Proposed Rules</label>
    <iron-list scroll-target="document" items="[[listRuleProposalsResp.rules]]" as="rule" grid>
      <template>
        <div>
          <pluot-rule rule="[[rule]]" on-tap="_onProposalTap"></pluot-rule>
        </div>
      </template>
    </iron-list>

    <label>Rules</label>
    <iron-list scroll-target="document" class="flex" items="[[listRulesResp.rules]]" as="rule" grid
        selection-enabled="true" selected-item="{{selectedRule}}">
      <template>
        <div>
          <pluot-rule rule="[[rule]]" selected="[[selected]]"></pluot-rule>
        </div>
      </template>
    </iron-list>

    <iron-ajax
        auto
        url="[[$.globals.urlPrefix]]rules"
        handle-as="json"
        last-response="{{listRulesResp}}"></iron-ajax>
    <iron-ajax
        auto
        url="[[$.globals.urlPrefix]]rules:proposal"
        handle-as="json"
        last-response="{{listRuleProposalsResp}}"></iron-ajax>
    <iron-ajax
        id="createRuleAjax"
        url="[[$.globals.urlPrefix]]rules"
        method="POST"
        content-type="application/json"
        body="[[_computeCreateRuleReq(newRulePattern, newRuleRegexp, newRuleCategoryStr, newRuleDisplayName)]]"
        handle-as="json"
        on-response="_addRule"></iron-ajax>
    <iron-ajax
        id="deleteRuleAjax"
        url="[[$.globals.urlPrefix]]rules/[[selectedRule.id]]"
        method="DELETE"
        on-response="_removeRule"></iron-ajax>
  </template>

  <script>
    class PluotRules extends Polymer.Element {
      static get is() { return 'pluot-rules'; }
      static get properties() {
        return {
          adding: { type: Boolean, notify: true, value: false },
          canDelete: { type: Boolean, notify: true, computed: '_computeCanDelete(selectedRule)' },
          newRulePattern: { type: String, value: "" },
          newRuleCategoryStr: { type: String, value: "" },
          newRuleRegexp: { type: Boolean, value: false },
          newRuleDisplayName: { type: String, value: "" },
        };
      }
      create() {
        this.newRulePattern = "";
        this.newRuleCategoryStr = "";
        this.newRuleRegexp = false;
        this.newRuleDisplayName = "";
        this.$.editDialog.open();
      }
      delete() {
        this.$.deleteRuleAjax.generateRequest();
      }
      _addRule(evt) {
        this.push('listRulesResp.rules', evt.target.lastResponse);
      }
      _removeRule(evt) {
        var parts = evt.target.lastRequest.url.split('/');
        var deletedId = parts[parts.length-1];
        // Find index of deleted rule.
        var deleted = -1;
        for (var i = 0; i < this.listRulesResp.rules.length; i++) {
          if (this.listRulesResp.rules[i].id == deletedId) {
            deleted = i;
            break;
          }
        }
        if (deleted != -1) {
          this.splice('listRulesResp.rules', deleted, 1);
        }
      }
      _computeCreateRuleReq(newRulePattern, newRuleRegexp, newRuleCategoryStr, newRuleDisplayName) {
        return {
          pattern: newRulePattern,
          regexp: newRuleRegexp,
          displayName: newRuleDisplayName,
          category: parseInt(newRuleCategoryStr)
        };
      }
      _computeCanDelete(selectedRule) { return selectedRule != null; }
      _formatCategory(category) { return this.$.globals.categoryName(category); }
      _onCreateRule() { this.$.createRuleAjax.generateRequest(); }
      _onProposalTap(evt) {
        this.newRulePattern = evt.currentTarget.rule.pattern;
        this.newRuleCategoryStr = String(evt.currentTarget.rule.category);
        this.newRuleDisplayName = evt.currentTarget.rule.displayName;
        this.$.editDialog.open();
      }
    }

    window.customElements.define(PluotRules.is, PluotRules);
  </script>
</dom-module>

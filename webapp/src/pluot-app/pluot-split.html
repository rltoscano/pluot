<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pluot-app/pluot-globals.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-shared-styles.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<script src="common.js"></script>

<dom-module id="pluot-split">
  <template>
    <style include="paper-dialog-shared-styles iron-flex iron-flex-alignment">
      :host {
        padding: 16px;
      }
      .splitamount {
        width: 50px;
      }
      .splitcat {
        width: 80px;
      }
      paper-item > * {
        margin-right: 16px;
      }
      paper-item > *:last-child {
        margin-right: 0;
      }
      paper-dialog-scrollable {
        --paper-dialog-scrollable: {
          padding: 0px;
        }
      }
      paper-dialog-scrollable > paper-item {
        padding: 0px;
      }
    </style>

    <pluot-globals id="globals"></pluot-globals>

    <h2 class="layout horizontal">
      <div class="flex">[[_formatDisplayName(_splitTxn)]]</div>
      <div style="padding-left: 32px;">Remaining: [[_formatAmount(_remainingSplitAmount)]]</div>
    </h2>
    <paper-dialog-scrollable>
      <template is="dom-repeat" items="{{_uiSplits}}">
        <paper-item class="layout horizontal">
          <paper-input label="Name" class="flex" type="text" value="{{item.displayName}}" autofocus></paper-input>
          <paper-dropdown-menu label="Category">
            <paper-listbox slot="dropdown-content" attr-for-selected="code" selected="{{item.category}}">
              <template is="dom-repeat" items="[[$.globals.categories]]">
                <paper-item code$="[[item.code]]">[[item.displayName]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-input label="Amount" class="splitamount" type="text" value="{{item.amount}}"></paper-input>
          <paper-icon-button icon="close" on-tap="_onRemoveSplitTap" data-index$="[[index]]"></paper-icon-button>
        </paper-item>
      </template>
      <paper-button on-tap="_onAddSplitTap" hidden$="[[!_remainingSplitAmount]]">Add Split</paper-button>
    </paper-dialog-scrollable>
    <div class="buttons">
      <paper-button dialog-dismiss>Cancel</paper-button>
      <paper-button dialog-confirm on-tap="_onSplitTap" disabled$="[[_computeSplitButtonDisabled(_remainingSplitAmount, splits)]]">Split</paper-button>
    </div>

  </template>

  <script>
    class PluotSplit extends Polymer.mixinBehaviors([Polymer.PaperDialogBehavior], Polymer.Element) {
      static get is() { return 'pluot-split'; }
      static get properties() {
        return {
          splitTxn: { type: Object, value: null },
          splits: { type: Array, computed: '_computeSplits(_uiSplits.*)', readOnly: true },
          _splitTxn: { type: Object, computed: '_computeSplitTxn(splitTxn)' },
          _uiSplits: { type: Array, value: [] },
          _remainingSplitAmount: { type: Number, computed: '_computeRemainingSplitAmount(_splitTxn, splits)' },
        };
      }
      _formatDisplayName(txn) {
        if (txn.userDisplayName != "") {
          return txn.userDisplayName;
        }
        if (txn.displayName != "") {
          return txn.displayName;
        }
        return txn.originalDisplayName;
      }
      _formatAmount(amount) { return formatAmount(amount); }
      _onSplitTap(evt) {
        this.dispatchEvent(
            new CustomEvent(
                'split',
                {detail: {splitTxn: this.splitTxn, splits: this.splits}}));
        this._uiSplits = [];
      }
      _computeRemainingSplitAmount(_splitTxn, splits) {
        if (_splitTxn == null || typeof(splits) == 'undefined') {
          return 0;
        }
        return splits.reduce(
          (remaining, split) => remaining - split.amount, _splitTxn.amount);
      }
      _onAddSplitTap(evt) {
        this.push(
          '_uiSplits',
          {
            displayName: "",
            category: "1",
            amount: String(this._remainingSplitAmount / 100)
          });
        setTimeout(this.refit.bind(this), 0);
      }
      _computeSplits(_uiSplitsProp) {
        return _uiSplitsProp.base.map(ui => ({
          displayName: ui.displayName,
          category: parseInt(ui.category),
          amount: parseFloat(ui.amount) * 100,
        }));
      }
      _computeSplitButtonDisabled(_remainingSplitAmount, splits) {
        return _remainingSplitAmount != 0 ||
            splits.some(s => !s.displayName || !s.category || !s.amount);
      }
      _onRemoveSplitTap(evt) {
        this.splice('_uiSplits', evt.currentTarget.dataset.index, 1);
        setTimeout(this.refit.bind(this), 0);
      }
      _computeSplitTxn(splitTxn) {
        if (splitTxn == null) {
          splitTxn = {
            originalDisplayName: "hello world",
            userDisplayName: "",
            displayName: "",
            amount: 0,
          };
        }
        return splitTxn;
      }
    }
    window.customElements.define(PluotSplit.is, PluotSplit);
  </script>
</dom-module>

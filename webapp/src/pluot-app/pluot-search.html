<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pluot-app/pluot-globals.html">

<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<dom-module id="pluot-search">
  <template>
    <style>
      paper-input {
        --paper-input-container-input-color: #fff;
        --paper-input-container-focus-color: #fff;
        background-color: #583759;
        padding-left: 16px;
        padding-right: 16px;
      }
    </style>

    <pluot-globals id="globals"></pluot-globals>

    <paper-input
        label="Search (e.g. cat:Groceries after:2017-08-21)"
        value="{{queryStr}}"
        autofocus></paper-input>

  </template>

  <script>
    class PluotSearch extends Polymer.Element {
      static get is() { return 'pluot-search'; }
      static get properties() {
        return {
          query: {
            type: Object,
            notify: true,
            readOnly: true,
            computed: '_computeQuery(queryStr)'
          },
          queryStr: { type: String, notify: true, value: '' },
        };
      }
      _computeQuery(queryStr) {
        var tokens = this._parse(queryStr);
        var query = {
          displayName: "",
          categories: [],
          before: null,
          after: null
        };
        tokens.forEach(token => {
          if (token.startsWith('cat:')) {
            query.categories.push(
              this.$.globals.categoryCode(token.substr('cat:'.length)));
          } else if (token.startsWith('after:')) {
            query.after = token.substr('after:'.length);
          } else if (token.startsWith('before:')) {
            query.before = token.substr('before:'.length);
          }
          // TODO(robert): Support searching by display name.
        });
        return query;
      }
      _parse(queryStr) {
        var tokens = queryStr.split(' ');
        var quoteJoinedTokens = [];
        var i = 0;
        for (var i = 0; i < tokens.length; i++) {
          if (!tokens[i].includes('"')) {
            quoteJoinedTokens.push(tokens[i]);
            continue;
          }
          // Scan ahead.
          var j = i + 1;
          for (; j < tokens.length; j++) {
            if (tokens[j].includes('"')) {
              break;
            }
          }
          if (j == tokens.length) {
            quoteJoinedTokens.push(tokens[i].replace(/"/g, ''));
            continue;
          }
          var joinedToken = tokens[i];
          for (var k = i + 1; k <= j; k++) {
            joinedToken += ' ' + tokens[k];
          }
          quoteJoinedTokens.push(joinedToken.replace(/"/g, ''));
          i = j;
        }
        return quoteJoinedTokens;
      }
    }
    window.customElements.define(PluotSearch.is, PluotSearch);
  </script>
</dom-module>

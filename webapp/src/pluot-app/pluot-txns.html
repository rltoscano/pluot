<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pluot-app/pluot-globals.html">
<link rel="import" href="../pluot-app/pluot-split.html">

<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<script src="common.js"></script>

<dom-module id="pluot-txns">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--layout-vertical);
      }
      .date {
        width: 64px;
      }
      .category {
        width: 128px;
      }
      iron-list paper-item {
        border-bottom: 1px black solid;
      }
      paper-item > * {
        padding-left: 16px;
      }
      paper-item > *:first-child {
        padding-left: 0px;
      }
      iron-list paper-item.is-selected-true {
        background-color: #583759;
        color: #fff;
      }
      #queryInput {
        --paper-input-container-input-color: #fff;
        background-color: #583759;
      }
    </style>

    <pluot-globals id="globals" categories="{{categories}}"></pluot-globals>

    <iron-a11y-keys target="[[$.txnList]]" keys="[[_computeEditKeys(selectedTxnIds)]]" on-keys-pressed="edit"></iron-a11y-keys>
    <iron-a11y-keys target="[[$.txnList]]" keys="[[_computeSplitKeys(selectedTxnIds)]]" on-keys-pressed="split"></iron-a11y-keys>

    <paper-input id="queryInput" value="{{queryStr}}" hidden></paper-input>

    <iron-list
        class="flex"
        items="[[_filter(query, listResp.txns)]]"
        as="txn"
        multi-selection
        id="txnList"
        selection-enabled
        on-selected-items-changed="_onSelectedItemsChanged">
      <template>
        <paper-item class$="layout horizontal is-selected-[[selected]]">
          <div class="date">[[_formatDate(txn.postDate)]]</div>
          <div class="displayName flex">[[_formatDisplayName(txn)]]</div>
          <div class="amount">[[_formatAmount(txn.amount)]]</div>
          <div class="category">[[_formatCategory(txn)]]</div>
        </paper-item>
      </template>
    </iron-list>

    <paper-dialog id="editDialog" class="layout vertical" fit-into="[[$.txnList]]" modal>
      <h2>[[selectedTxnIds.length]] Transactions Selected</h2>
      <paper-input autofocus label="Description" value="{{editDisplayName}}"></paper-input>
      <paper-dropdown-menu label="Category">
        <paper-listbox slot="dropdown-content" attr-for-selected="code" selected="{{editCategory}}">
          <template is="dom-repeat" items="[[categories]]" as="category">
            <paper-item code$="[[category.code]]">[[category.displayName]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="_submitPatchReq">Accept</paper-button>
      </div>
    </paper-dialog>

    <pluot-split id="splitDialog" fit-into="[[$.txnList]]" modal on-split="_onSplitTxn"></pluot-split>

    <iron-ajax
        auto
        url="[[$.globals.urlPrefix]]txns"
        handle-as="json"
        last-response="{{listResp}}"></iron-ajax>
    <iron-ajax
        id="patchAjax"
        url="[[$.globals.urlPrefix]]txns"
        method="PATCH"
        content-type="application/json"
        body="[[patchReq]]"
        handle-as="json"
        on-response="_onPatchAjaxResponse"></iron-ajax>
  </template>
  <script>
    class PluotTxns extends Polymer.Element {
      static get is() { return 'pluot-txns'; }
      static get properties() {
        return {
          toolbar: {
            type: Array,
            notify: true,
            computed: '_computeToolbar(selectedTxnIds)'
          },
          patchReq: {
            type: Object,
            computed: '_computePatchReq(selectedTxnIds, editDisplayName, editCategory)'
          },
          selectedTxnIds: { type: Array, value: [] },
          editDisplayName: { type: String, value: "" },
          editCategory: { type: Number, value: null },
          queryStr: { type: String, value: '' },
          query: { type: Object, computed: '_computeQuery(queryStr)' },
          listResp: { type: Object, value: { txns: [] } },
          splitTxn: { type: Object, value: null },
          splits: { type: Array, value: [ {displayName: "test", category: "3", amount: "-40" } ] },
          remainingSplitAmount: { type: Number, computed: '_computeRemainingSplitAmount(splitTxn, splits)' },
        };
      }
      edit() {
        if (this.selectedTxnIds.length == 1) {
          var selectedTxn = this.$.txnList.selectedItems[0];
          this.editDisplayName = selectedTxn.userDisplayName || selectedTxn.displayName || selectedTxn.originalDisplayName;
          this.editCategory = selectedTxn.userCategory || selectedTxn.category;
        } else {
          this.editDisplayName = "";
          this.editCategory = null;
        }
        this.$.editDialog.open();
      }
      search() {
        this.$.queryInput.value = "";
        this.$.queryInput.hidden = !this.$.queryInput.hidden;
      }
      split() {
        this.$.splitDialog.splitTxn = this.$.txnList.selectedItems[0];
        this.$.splitDialog.open();
      }
      _computeToolbar(selectedTxnIds) {
        return [
          { icon: 'image:edit', handler: 'edit', disabled: (selectedTxnIds.length == 0) },
          { icon: 'search', handler: 'search' },
          { icon: 'communication:call-split', handler: 'split', disabled: (selectedTxnIds.length != 1) },
        ];
      }
      _computePatchReq(selectedTxnIds, editDisplayName, editCategory) {
        var fields = [];
        if (typeof(editDisplayName) != 'undefined' && editDisplayName != '') {
          fields.push('userDisplayName');
        }
        if (editCategory > 0) {
          fields.push('userCategory');
          editCategory = parseInt(editCategory);
        }
        return {
          ids: selectedTxnIds,
          txn: { userDisplayName: editDisplayName, userCategory: editCategory },
          fields: fields,
        };
      }
      _formatDate(str) { return formatDate(str); }
      _formatCategory(txn) {
        var category = txn.category;
        if (txn.userCategory > 0) {
          category = txn.userCategory;
        }
        return this.$.globals.categoryName(category);
      }
      _formatAmount(amount) { return formatAmount(amount); }
      _formatDisplayName(txn) {
        if (txn.userDisplayName != "") {
          return txn.userDisplayName;
        }
        if (txn.displayName != "") {
          return txn.displayName;
        }
        return txn.originalDisplayName;
      }
      _submitPatchReq() {
        this.$.patchAjax.generateRequest();
      }
      _onSelectedItemsChanged(evt) {
        this.selectedTxnIds = evt.currentTarget.selectedItems.map(t => t.id);
      }
      _onPatchAjaxResponse(evt) {
        for (var i = 0; i < this.listResp.txns.length; i++) {
          for (var j = 0; j < evt.currentTarget.lastResponse.txns.length; j++) {
            if (this.listResp.txns[i].id == evt.currentTarget.lastResponse.txns[j].id) {
              this.set('listResp.txns.'+i, evt.currentTarget.lastResponse.txns[j]);
            }
          }
        }
        this.$.txnList.clearSelection();
      }
      _computeEditKeys(selectedTxnIds) {
        return (selectedTxnIds.length == 0) ? "" : "e";
      }
      _computeSplitKeys(selectedTxnIds) {
        return (selectedTxnIds.length != 1) ? "" : "s";
      }
      _filter(query, txns) {
        return txns.filter(txn => {
          if (query.categories.length > 0) {
            var cat = (txn.userCategory != 0) ? txn.userCategory : txn.category;
            if (!query.categories.includes(cat)) {
              return false;
            }
          }
          if (query.after != null && query.after >= txn.postDate.substr(0, 10)) {
            return false;
          }
          if (query.before != null && query.before <= txn.postDate.substr(0, 10)) {
            return false;
          }
          return true;
        });
      }
      _computeQuery(queryStr) {
        var tokens = queryStr.split(' ');
        var query = {
          displayName: "",
          categories: [],
          before: null,
          after: null
        };
        tokens.forEach(token => {
          if (token.startsWith('cat:')) {
            query.categories.push(
              this.$.globals.categoryCode(token.substr('cat:'.length)));
          } else if (token.startsWith('after:')) {
            query.after = token.substr('after:'.length);
          } else if (token.startsWith('before:')) {
            query.before = token.substr('before:'.length);;
          }
          // TODO(robert): Support searching by display name.
        });
        return query;
      }
      _onSplitTxn(evt) {
        alert('wut');
      }
    }
    window.customElements.define(PluotTxns.is, PluotTxns);
  </script>

</dom-module>

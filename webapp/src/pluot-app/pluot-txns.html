<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pluot-app/pluot-amount.html">
<link rel="import" href="../pluot-app/pluot-category.html">
<link rel="import" href="../pluot-app/pluot-edit.html">
<link rel="import" href="../pluot-app/pluot-format.html">
<link rel="import" href="../pluot-app/pluot-globals.html">
<link rel="import" href="../pluot-app/pluot-txn.html">
<link rel="import" href="../pluot-app/pluot-search.html">
<link rel="import" href="../pluot-app/pluot-split.html">

<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/iron-icons/places-icons.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<dom-module id="pluot-txns">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--layout-vertical);
      }
      pluot-txn {
        border-bottom-width: 1px;
        border-bottom-color: #eee;
        border-bottom-style: solid;
      }
      #add {
        padding: 16px;
      }
    </style>

    <pluot-globals id="globals"></pluot-globals>

    <iron-pages
        id="main"
        selected="[[mode]]"
        attr-for-selected="id">

      <iron-list
          id="list"
          class="flex"
          items="[[_txnModel.filtered]]"
          scroll-target="document">
        <template>
          <pluot-txn
              txn="[[item]]"
              on-edit="_patch"
              on-split="_showSplit"
              on-resize="_resizeItem"></pluot-txn>
        </template>
      </iron-list>

      <pluot-split
          id="split"
          page="split"
          split-txn="[[_splitTxn]]"
          splits="{{_splits}}"
          on-done="_sendSplitRequest"></pluot-split>

      <div id="add">
        <pluot-amount amount="{{_addAmount}}"></pluot-amount>
        <pluot-category code="{{_addCategory}}"></pluot-category>
        <paper-input
            type="date"
            label="Date"
            value="{{_addDate}}"></paper-input>
        <paper-input value="{{_addDescription}}" label="Description"></paper-input>
        <paper-button raised on-tap="_createTxn">Done</paper-button>
      </div>

    </iron-pages>

    <iron-ajax
        auto
        url="[[$.globals.urlPrefix]]txns"
        handle-as="json"
        last-response="{{_listResp}}"></iron-ajax>
    <iron-ajax
        id="patchAjax"
        method="PATCH"
        content-type="application/json"
        handle-as="json"
        on-response="_updateTxnListAndToast"
        on-error="_toastTxnEditFailed"></iron-ajax>
    <iron-ajax
        id="splitAjax"
        url="[[$.globals.urlPrefix]]txns:split"
        method="POST"
        content-type="application/json"
        body="[[_computeSplitReq(_splitTxn, _splits.*)]]"
        handle-as="json"
        on-response="_toastSplitSuccess"></iron-ajax>
    <iron-ajax
        id="createAjax"
        url="[[$.globals.urlPrefix]]txns"
        method="POST"
        content-type="application/json"
        body="[[_computeCreateReq(_addAmount, _addCategory, _addDate, _addDescription)]]"
        handle-as="json"
        on-response="_toastAndInsertTransaction"
        on-error="_toastCreateTxnFailed"></iron-ajax>


    <paper-toast id="toast" fit-into="[[$.main]]"></paper-toast>
  </template>
  <script>
    class PluotTxns extends PluotFormat(Polymer.Element) {
      static get is() { return 'pluot-txns'; }
      static get properties() {
        return {
          mode: { type: String, notify: true, value: 'list' },
          query: { type: Object, value: null },
          _addDate: { type: String, value: new Date().toISOString().substring(0, 10) },
          _listResp: { type: Object, value: { txns: [] } },
          _splitTxn: { type: Object, value: { id: 0 } },
          _splits: { type: Array, value: [] },
          _txnModel: { type: Object, computed: '_computeTxnModel(query, _listResp.txns.*)' },
        };
      }
      _patch(evt) {
        this.$.list.notifyResize();
        console.log('Patching..');
        var body = { txn: {id: evt.detail.id}, fields: [] };
        if (evt.detail.field === 'name') {
          body.fields.push('userDisplayName');
          body.txn.userDisplayName = evt.detail.value;
        } else if (evt.detail.field === 'category') {
          body.fields.push('userCategory');
          body.txn.userCategory = evt.detail.value;
        } else {
          alert('Unexpected transaction edit');
          return;
        }
        this.$.patchAjax.url = this.$.globals.urlPrefix + 'txns/' + evt.detail.id;
        this.$.patchAjax.body = body;
        this.$.patchAjax.generateRequest();
      }
      _computeCreateReq(_addAmount, _addCategory, _addDate, _addDescription) {
        if (!_addAmount || !_addCategory || !_addDate || !_addDescription) {
          return {};
        }
        return {
          txn: {
            amount: _addAmount,
            userCategory: _addCategory,
            postDate: new Date(_addDate).toUTCString(),
            userDisplayName: _addDescription,
          }
        };
      }
      _computeTxnModel(query, txnsProp) {
        var txns = txnsProp.base;
        var model = { txnById: {}, filtered: [] };
        if (!txns) {
          return model;
        }
        txns.forEach(t => {
          model.txnById[t.id] = t;
          if (this._filter(t, query)) {
            model.filtered.push(t);
          }
        });
        return model;
      }
      _computeSplitReq(_splitTxn, _splitsProp) {
        return { sourceId: _splitTxn.id, splits: _splitsProp.base };
      }
      _createTxn(evt) {
        this.$.createAjax.generateRequest();
        this.mode = 'list';
      }
      _toastSplitSuccess(evt) {
        this.$.toast.text = 'Transaction split';
        this.$.toast.open();
        // TODO(robert): Apply changes to model.
      }
      _updateTxnListAndToast(evt) {
        for (var i = 0; i < this._listResp.txns.length; i++) {
          if (this._listResp.txns[i].id == evt.target.lastResponse.id) {
            this.splice('_listResp.txns', i, 1, evt.target.lastResponse);
            break;
          }
        }
        console.log('Txn patched: ' + evt.detail);
        this.$.toast.text = 'Transaction updated';
        this.$.toast.open();
      }
      _toastTxnEditFailed(evt) {
        this.$.toast.text = 'Transaction update failed';
        this.$.toast.open();
      }
      _sendSplitRequest(evt) {
        this.mode = 'list';
        this.$.splitAjax.generateRequest();
      }
      _showSplit(evt) {
        var splitSource = this._txnModel.txnById[evt.detail.id];
        if (splitSource.splitSourceId) {
          splitSource = this._txnModel.txnById[splitSource.splitSourceId];
        }
        this._splitTxn = splitSource;
        this._splits =
            (splitSource.splits || [])
                .map(id => this._txnModel.txnById[id])
                .map(s => (
                    {
                      displayName: s.userDisplayName,
                      category: s.userCategory,
                      amount: s.amount
                    }));
        this.mode = 'split';
      }
      _filter(txn, query) {
        if (txn.splits && txn.splits.length > 0) { // Hide split sources.
          return false;
        }
        if (query == null) {
          return true;
        }
        if (query.categories.length > 0) {
          if (!query.categories.includes(txn.userCategory || txn.category)) {
            return false;
          }
        }
        var postDate = new Date(txn.postDate);
        if (query.after != null && query.after.getTime() > postDate.getTime()) {
          return false;
        }
        if (query.before != null && query.before.getTime() <= postDate.getTime()) {
          return false;
        }
        if (query.isExpense != null &&
            query.isExpense == this.$.globals.isIncome(txn.userCategory || txn.category)) {
          return false;
        }
        return true;
      }
      _resizeItem(evt) {
        if (evt.target.txn) {
          this.$.list.updateSizeForItem(evt.target.txn);
        }
      }
      _toastAndInsertTransaction(evt) {
        this.$.toast.text = "Transaction created";
        this.$.toast.open();
        this.unshift('_listResp.txns', evt.target.lastResponse);
      }
      _toastCreateTxnFailed(evt) {
        this.$.toast.text = 'Transaction creation failed';
        this.$.toast.open();
      }
    }
    window.customElements.define(PluotTxns.is, PluotTxns);
  </script>

</dom-module>

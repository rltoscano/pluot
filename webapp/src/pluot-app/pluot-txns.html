<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pluot-app/pluot-edit.html">
<link rel="import" href="../pluot-app/pluot-format.html">
<link rel="import" href="../pluot-app/pluot-globals.html">
<link rel="import" href="../pluot-app/pluot-search.html">
<link rel="import" href="../pluot-app/pluot-split.html">

<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<dom-module id="pluot-txns">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--layout-vertical);
      }
      .date {
        width: 64px;
      }
      .category {
        width: 128px;
      }
      iron-list paper-item {
        border-bottom: 1px black solid;
      }
      paper-item > * {
        padding-left: 16px;
      }
      paper-item > *:first-child {
        padding-left: 0px;
      }
      iron-list paper-item.is-selected-true {
        background-color: #583759;
        color: #fff;
      }
    </style>

    <pluot-globals id="globals"></pluot-globals>

    <iron-a11y-keys target="[[$.txnList]]" keys="[[_computeEditKeys(_selected.length)]]" on-keys-pressed="edit"></iron-a11y-keys>
    <iron-a11y-keys target="[[$.txnList]]" keys="[[_computeSplitKeys(_selected.length)]]" on-keys-pressed="split"></iron-a11y-keys>
    <iron-a11y-keys target="[[$.txnList]]" keys="/" on-keys-pressed="search"></iron-a11y-keys>

    <pluot-search id="search" query="{{query}}" hidden></pluot-search>

    <iron-list id="txnList" class="flex" items="[[_txnModel.filtered]]" multi-selection selection-enabled selected-items="{{_selected}}">
      <template>
        <paper-item class$="layout horizontal is-selected-[[selected]]">
          <div class="date">[[_formatDate(item.postDate)]]</div>
          <div class="displayName flex">[[_formatDisplayName(item)]]</div>
          <div class="splitbadge">
            <template is="dom-if" if="[[item.splitSourceId]]">
              <iron-icon icon="communication:call-split"></iron-icon>
            </template>
          </div>
          <div class="amount">[[_formatAmount(item.amount)]]</div>
          <div class="category">[[_formatCategory(item)]]</div>
        </paper-item>
      </template>
    </iron-list>

    <pluot-edit id="editDialog" fit-into="[[$.txnList]]" on-iron-overlay-closed="_onEditClosed" txn="{{_editTxn}}" num-selected="[[_selected.length]]"></pluot-edit>
    <pluot-split id="splitDialog" fit-into="[[$.txnList]]" on-iron-overlay-closed="_onSplitClose" split-txn="[[_splitTxn]]" splits="{{_splits}}"></pluot-split>

    <iron-ajax auto url="[[$.globals.urlPrefix]]txns" handle-as="json" last-response="{{listResp}}"></iron-ajax>
    <iron-ajax id="patchAjax" url="[[$.globals.urlPrefix]]txns" method="PATCH" content-type="application/json" body="[[_computePatchReq(_selected, _editTxn.*)]]" handle-as="json" on-response="_onPatchAjaxResponse"></iron-ajax>
    <iron-ajax id="splitAjax" url="[[$.globals.urlPrefix]]txns:split" method="POST" content-type="application/json" body="[[_computeSplitReq(_splitTxn, _splits.*)]]" handle-as="json" on-response="_onSplitResponse"></iron-ajax>
  </template>
  <script>
    class PluotTxns extends PluotFormat(Polymer.Element) {
      static get is() { return 'pluot-txns'; }
      static get properties() {
        return {
          toolbar: { type: Array, notify: true, computed: '_computeToolbar(_selected.length)' },
          _txnModel: { type: Object, computed: '_computeTxnModel(query, listResp.txns.*)' },
          _editTxn: { type: Object, value: { displayName: "", category: null } },
          listResp: { type: Object, value: { txns: [] } },
          _splitTxn: { type: Object, computed: '_computeSplitTxn(_selected.*, _txnModel)' },
          _splits: { type: Array, value: [] },
          _selected: { type: Array, value: [] },
        };
      }
      static get observers() {
        return [
          '_updateEditTxn(_selected.*)',
          '_updateSplits(_splitTxn, _txnModel)',
        ];
      }
      edit() { this.$.editDialog.open(); }
      search() {
        this.$.search.reset();
        this.$.search.hidden = !this.$.search.hidden;
      }
      split() { this.$.splitDialog.open(); }
      _updateEditTxn(_selectedProp) {
        var displayName = '';
        var category = null;
        if (_selectedProp.base.length == 1) {
          var t = _selectedProp.base[0];
          displayName = t.userDisplayName || t.displayName || t.originalDisplayName;
          category = t.userCategory || t.category;
        }
        this._editTxn = { displayName: displayName, category: category };
      }
      _updateSplits(_splitTxn, _txnModel) {
        if (!_splitTxn.splits) {
          this._splits = [];
        } else {
          this._splits =
              _splitTxn.splits
                  .map(id => _txnModel.txnById[id])
                  .map(s => ({ displayName: s.userDisplayName, category: s.userCategory, amount: s.amount }));
        }
      }
      _computeTxnModel(query, txnsProp) {
        var txns = txnsProp.base;
        var model = { txnById: {}, filtered: [] };
        if (!txns) {
          return model;
        }
        txns.forEach(t => {
          model.txnById[t.id] = t;
          if (this.$.search.filter(t)) {
            model.filtered.push(t);
          }
        });
        return model;
      }
      _computeToolbar(_selectedLength) {
        return [
          { icon: 'image:edit', handler: 'edit', disabled: (_selectedLength == 0) },
          { icon: 'search', handler: 'search' },
          { icon: 'communication:call-split', handler: 'split', disabled: (_selectedLength != 1) },
        ];
      }
      _computePatchReq(_selected, _editTxn) {
        var fields = [];
        _editTxn = _editTxn.base;
        if (_editTxn.displayName) {
          fields.push('userDisplayName');
        }
        if (_editTxn.category) {
          fields.push('userCategory');
        }
        return {
          ids: _selected.map(t => t.id),
          txn: { userDisplayName: _editTxn.displayName, userCategory: _editTxn.category },
          fields: fields,
        };
      }
      _computeEditKeys(_selectedLength) { return (_selectedLength == 0) ? "" : "e"; }
      _computeSplitKeys(_selectedLength) { return (_selectedLength != 1) ? "" : "s"; }
      _computeSplitTxn(_selectedProp, _txnModel) {
        if (_selectedProp.base.length != 1) {
          return { userDisplayName: "", amount: 0 };
        }
        var selectedTxn = _selectedProp.base[0];
        if (!selectedTxn.splitSourceId) {
          return selectedTxn
        } else {
          return _txnModel.txnById[selectedTxn.splitSourceId];;
        }
      }
      _computeSplitReq(_splitTxn, _splitsProp) {
        return { sourceId: _splitTxn.id, splits: _splitsProp.base };
      }
      _formatCategory(txn) { return this.$.globals.categoryName(txn.userCategory || txn.category); }
      _onEditClosed(evt) {
        if (evt.detail.confirmed) {
          this.$.patchAjax.generateRequest();
        }
      }
      _onPatchAjaxResponse(evt) {
        for (var i = 0; i < this.listResp.txns.length; i++) {
          for (var j = 0; j < evt.currentTarget.lastResponse.txns.length; j++) {
            if (this.listResp.txns[i].id == evt.currentTarget.lastResponse.txns[j].id) {
              this.set('listResp.txns.'+i, evt.currentTarget.lastResponse.txns[j]);
            }
          }
        }
        this.$.txnList.clearSelection();
      }
      _onSplitClose(evt) {
        if (evt.detail.confirmed) {
          this.$.splitAjax.generateRequest();
        }
      }
      _onSplitResponse(evt) {
        alert('split done');
        // TODO(robert): Apply changes to model.
      }
    }
    window.customElements.define(PluotTxns.is, PluotTxns);
  </script>

</dom-module>

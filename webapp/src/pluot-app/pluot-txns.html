<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pluot-app/pluot-edit.html">
<link rel="import" href="../pluot-app/pluot-format.html">
<link rel="import" href="../pluot-app/pluot-globals.html">
<link rel="import" href="../pluot-app/pluot-txn.html">
<link rel="import" href="../pluot-app/pluot-search.html">
<link rel="import" href="../pluot-app/pluot-split.html">

<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/iron-icons/places-icons.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<dom-module id="pluot-txns">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--layout-vertical);
      }
      pluot-txn {
        border-bottom-width: 1px;
        border-bottom-color: #eee;
        border-bottom-style: solid;
      }
    </style>

    <pluot-globals id="globals"></pluot-globals>

    <iron-a11y-keys target="[[$.txnList]]" keys="[[_computeSplitKeys(_selected.length)]]" on-keys-pressed="_toggleSplit"></iron-a11y-keys>
    <iron-a11y-keys target="[[$.txnList]]" keys="/" on-keys-pressed="_toggleSearch"></iron-a11y-keys>

    <pluot-search id="search" query="{{query}}" hidden$="[[!searching]]"></pluot-search>

    <iron-list id="txnList" class="flex" items="[[_txnModel.filtered]]" multi-selection selection-enabled selected-items="{{_selected}}">
      <template>
        <pluot-txn txn="[[item]]" on-edit="_patch"></pluot-txn>
      </template>
    </iron-list>

    <pluot-split fit-into="[[$.txnList]]" on-iron-overlay-closed="_onSplitClose" split-txn="[[_splitTxn]]" splits="{{_splits}}" opened="[[splitting]]"></pluot-split>

    <iron-ajax auto url="[[$.globals.urlPrefix]]txns" handle-as="json" last-response="{{_listResp}}"></iron-ajax>
    <iron-ajax id="patchAjax" method="PATCH" content-type="application/json" handle-as="json" on-response="_toastTxnEditSuccess" on-error="_toastTxnEditFailed"></iron-ajax>
    <iron-ajax id="splitAjax" url="[[$.globals.urlPrefix]]txns:split" method="POST" content-type="application/json" body="[[_computeSplitReq(_splitTxn, _splits.*)]]" handle-as="json" on-response="_toastSplitSuccess"></iron-ajax>

    <paper-toast id="toast" fit-into="[[$.txnList]]"></paper-toast>
  </template>
  <script>
    class PluotTxns extends PluotFormat(Polymer.Element) {
      static get is() { return 'pluot-txns'; }
      static get properties() {
        return {
          canSplit: { type: Boolean, notify: true, computed: '_computeCanSplit(_selected.length)' },
          searching: { type: Boolean, notify: true, value: false, observer: '_resetSearch' },
          splitting: { type: Boolean, notify: true, value: false },
          _listResp: { type: Object, value: { txns: [] } },
          _selected: { type: Array, value: [] },
          _splitTxn: { type: Object, computed: '_computeSplitTxn(_selected.*, _txnModel)' },
          _splits: { type: Array, value: [] },
          _txnModel: { type: Object, computed: '_computeTxnModel(query, _listResp.txns.*)' },
        };
      }
      static get observers() { return [ '_updateSplits(_splitTxn, _txnModel)' ]; }
      _patch(evt) {
        this.$.txnList.notifyResize();
        console.log('Patching..');
        var body = { txn: {id: evt.detail.id}, fields: [] };
        if (evt.detail.field === 'name') {
          body.fields.push('userDisplayName');
          body.txn.userDisplayName = evt.detail.value;
        } else if (evt.detail.field === 'category') {
          body.fields.push('userCategory');
          body.txn.userCategory = evt.detail.value;
        } else {
          alert('Unexpected transaction edit');
          return;
        }
        this.$.patchAjax.url = this.$.globals.urlPrefix + 'txns/' + evt.detail.id;
        this.$.patchAjax.body = body;
        this.$.patchAjax.generateRequest();
      }
      _resetSearch() { this.$.search.reset(); }
      _toggleSearch() { this.searching = !this.searching; }
      _toggleSplit() { this.splitting = !this.splitting; }
      _updateSplits(_splitTxn, _txnModel) {
        if (!_splitTxn.splits) {
          this._splits = [];
        } else {
          this._splits =
              _splitTxn.splits
                  .map(id => _txnModel.txnById[id])
                  .map(s => ({ displayName: s.userDisplayName, category: s.userCategory, amount: s.amount }));
        }
      }
      _computeTxnModel(query, txnsProp) {
        var txns = txnsProp.base;
        var model = { txnById: {}, filtered: [] };
        if (!txns) {
          return model;
        }
        txns.forEach(t => {
          model.txnById[t.id] = t;
          if (this.$.search.filter(t)) {
            model.filtered.push(t);
          }
        });
        return model;
      }
      _computeCanSplit(_selectedLength) { return _selectedLength == 1; }
      _computeSplitKeys(_selectedLength) { return (_selectedLength != 1) ? "" : "s"; }
      _computeSplitTxn(_selectedProp, _txnModel) {
        if (_selectedProp.base.length != 1) {
          return { userDisplayName: "", amount: 0 };
        }
        var selectedTxn = _selectedProp.base[0];
        if (!selectedTxn.splitSourceId) {
          return selectedTxn
        } else {
          return _txnModel.txnById[selectedTxn.splitSourceId];;
        }
      }
      _computeSplitReq(_splitTxn, _splitsProp) {
        return { sourceId: _splitTxn.id, splits: _splitsProp.base };
      }
      _onSplitClose(evt) {
        if (evt.detail.confirmed) {
          this.$.splitAjax.generateRequest();
        }
      }
      _toastSplitSuccess(evt) {
        this.$.toast.text = 'Transaction split';
        this.$.toast.open();
        // TODO(robert): Apply changes to model.
      }
      _toastTxnEditSuccess() {
        this.$.toast.text = 'Transaction updated';
        this.$.toast.open();
      }
      _toastTxnEditFailed(evt) {
        this.$.toast.text = 'Transaction update failed';
        this.$.toast.open();
      }
    }
    window.customElements.define(PluotTxns.is, PluotTxns);
  </script>

</dom-module>

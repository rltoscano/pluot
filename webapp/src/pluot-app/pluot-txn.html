<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pluot-app/pluot-category.html">
<link rel="import" href="../pluot-app/pluot-format.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<dom-module id="pluot-txn">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        font-family: sans-serif;
        padding: 16px;
      }
      #main {
        overflow: hidden;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      paper-input {
        padding-left: 16px;
        --paper-input-container: {
          padding: 0;
          vertical-align: middle;
        };
        --paper-input-container-input: {
          cursor: text;
          vertical-align: top;
        };
      }
      paper-input[readonly] {
        --paper-input-container-underline: {
          border: none;
        };
        --paper-input-container-input: {
          cursor: pointer;
          vertical-align: top;
        };
      }
      .subtitle {
        font-size: 75%;
        color: gray;
      }
    </style>

    <div id="main">
      <pluot-category code="{{_category}}" selecting="{{_selectingCategory}}"></pluot-category>
      <paper-input
          class="flex"
          value="{{_name}}"
          readonly$="[[!_editingName]]"
          focused="{{_editingName}}"
          on-change="_dispatchNameChanged"
          hidden$="[[_selectingCategory]]"></paper-input>
      <template is="dom-if" if="[[txn.splitSourceId]]">
        <iron-icon icon="communication:call-split" hidden$="[[_selectingCategory]]"></iron-icon>
      </template>
      <div class="layout vertical end" style="width: 65px;">
        <div
            on-tap="_dispatchSplit"
            style="cursor: pointer;"
            hidden$="[[_selectingCategory]]">[[_formatAmount(txn.amount)]]</div>
        <div class="subtitle" hidden$="[[_selectingCategory]]">[[_formatDate(txn.postDate)]]</div>
      </div>
    </div>

  </template>

  <script>
    class PluotTxn extends PluotFormat(Polymer.Element) {
      static get is() { return 'pluot-txn'; }
      static get properties() {
        return {
          txn: { type: Object, value: null, observer: '_updateModel' },
          _selectingCategory: { type: Boolean, value: false, observer: '_dispatchResize' },
          _editingName: { type: Boolean, value: false },
          _category: { type: Number, value: 1, observer: '_maybeDispatchCategory' },
          _name: { type: String, value: null },
        };
      }
      _updateModel(txn) {
        if (txn != null) {
          this.setProperties({
            _category: txn.userCategory || txn.category,
            _name: this._formatDisplayName(txn),
          });
        }
      }
      _dispatchNameChanged(evt) {
        console.log('Name changed: ' + evt.target.value);
        this.dispatchEvent(
            new CustomEvent(
                'edit', {detail: {id: this.txn.id, field: 'name', value: evt.target.value }}));
      }
      _dispatchSplit() {
        console.log('Split requested: ' + this.txn.id);
        this.dispatchEvent(new CustomEvent('split', {detail: { id: this.txn.id }}));
      }
      _dispatchResize() { this.dispatchEvent(new CustomEvent('resize')); }
      _maybeDispatchCategory(newValue) {
        if (this.txn && newValue !== (this.txn.userCategory || this.txn.category)) {
          console.log('Category selection changed: ' + newValue);
          this.dispatchEvent(
              new CustomEvent(
                  'edit', {detail: {id: this.txn.id, field: 'category', value: newValue }}));
        }
      }
    }
    window.customElements.define(PluotTxn.is, PluotTxn);
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="pluot-cat.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<dom-module id="pluot-txn">
  <template>
    <style include="iron-flex iron-flex-alignment">
      #date {
        width: 64px;
      }
      #container {
        border-bottom: 1px black solid;
      }
    </style>
    <paper-item id="container" class="layout horizontal layout-start">
      <div id="date">[[_friendlyDate(txn.postDate)]]</div>
      <div id="displayName" class="flex">[[txn.originalDisplayName]]</div>
      <pluot-cat cat="{{txn.category}}"></pluot-cat>
    </paper-item>

    <iron-ajax
        id="updateTxnAjax"
        url="http://localhost:8080/svc/txns/[[txn.id]]"
        method="POST"
        body="[[txn]]"
        handle-as="json"
        last-response="[[txn]]"
        debounce-duration="500">
    </iron-ajax>
  </template>

  <script>
    class PluotTxn extends Polymer.Element {
      static get is() { return 'pluot-txn'; }
      static get properties() {
        return {
          txn: { type: Object },
          _txnCatUpdateCount: { type: Number, value: 0 }
        };
      }
      static get observers() {
        return [
            '_handleTxnCategoryChange(txn.category)'
        ];
      }
      _friendlyDate(str) {
        var d = new Date(Date.parse(str));
        var options = {
          month: 'short',
          day: 'numeric',
        };
        return d.toLocaleString('en-US', options);
      }
      _handleTxnCategoryChange(txnCategory) {
        if (this._txnCatUpdateCount > 0) {
          this.$.updateTxnAjax.generateRequest();
        }
        this._txnCatUpdateCount++;
        console.log('Txn category changed, new: ' + txnCategory);
      }
    }
    window.customElements.define(PluotTxn.is, PluotTxn);
  </script>

</dom-module>
